{% extends 'examination/base.html' %}

{% block sidetabmenu %}
<div class="ui medium fluid vertical pointing menu" style="max-width: 320px;">
  <a class="active item" href="{% url 'examination:submitGradesProf' %}"><B>Submit</B>
    <i class="right floated chevron right icon"></i>
  </a>
  <a class="item" href="{% url 'examination:downloadGrades' %}">Download Grades
    <i class="right floated chevron right icon"></i>
  </a>
</div>
{% endblock %}

{% block content %}
<h1>Submit Results</h1>
<br />

<div style="display: flex; flex-direction: column; gap: 30px;">
    <div style="display: flex; flex-direction: row; gap: 50px;">
        <div style="display: flex; flex-direction: row; gap: 10px;">
            <div style="margin-top: 8px;">
                <label>Course</label>
            </div>
            <div class="ui selection dropdown" id="course-dropdown">
                <input type="hidden" name="course">
                <i class="dropdown icon"></i>
                <div class="default text">Select Course</div>
                <div class="menu">
                    {% for course in courses_info %}
                    <div class="item" data-value="{{ course.id }}"> {{ course.code }} - {{ course.name }} - {{ course.version }}</div>
                    {% empty %}
                    <div class="item">No Courses Available</div>
                    {% endfor %}
                </div>
            </div>
        </div>
        <div style="display: flex; flex-direction: row; gap: 10px;">
            <div style="margin-top: 8px;">
                <label>Academic Year</label>
            </div>
            <div class="ui selection dropdown" id="year-dropdown">
                <input type="hidden" name="year">
                <i class="dropdown icon"></i>
                <div class="default text">Select Year</div>
                <div class="menu">
                    {% for working_year in working_years %}
                    <div class="item" data-value="{{ working_year.working_year }}"> {{ working_year.working_year }}</div>
                    {% empty %}
                    <div class="item">No Years Available</div>
                    {% endfor %}
                </div>
            </div>
        </div>
        {% comment %} <div style="display: flex; flex-direction: row; gap: 10px;"> 
                   <div style="margin-top: 8px;">
                <label>Semester</label>
            </div> 
             <div class="ui selection dropdown" id="semester-dropdown">
                <input type="hidden" name="semester">
                <i class="dropdown icon"></i>
                <div class="default text">Select Semester</div>
                <div class="menu">
                  <div class="item" data-value=1>1</div>
                  <div class="item" data-value=2>2</div>
                  <div class="item" data-value=3>3</div>
                  <div class="item" data-value=4>4</div>
                  <div class="item" data-value=5>5</div>
                  <div class="item" data-value=6>6</div>
                  <div class="item" data-value=7>7</div>
                  <div class="item" data-value=8>8</div>
                </div>
            </div> 
        </div> {% endcomment %}
    </div>

    <div style="display: flex; flex-direction: row; gap: 50px; margin-left: 10px;" id="upload-section">
        <input type="file" id="csv-file" accept=".csv" style="padding: 0px; width: 177px;">
        <button class="ui primary button" onclick="upload()">Upload Results</button>
    </div>
    
    <div style="display: flex; flex-direction: row; gap: 50px; margin-left: 10px; ">

        <button class="ui primary button" onclick="dwn_temp()">Download Template</button>
    
    </div>
</div>

<script>
    function upload() {
       
        let selectedCourse = $('#course-dropdown .menu .item.active').attr('data-value');
        let selectedYear = $('#year-dropdown .menu .item.active').attr('data-value');
       // let selectedSemester = $('#semester-dropdown .menu .item.active').attr('data-value');
        
       
        let fileInput = document.getElementById('csv-file');
        let file = fileInput.files[0];
        console.log(selectedCourse,selectedYear,file);
    
        if (!selectedCourse || !selectedYear || !file) {
            alert('Please select course, year, and upload a CSV file.');
            return;
        }

        if (!confirm('Are you sure you want to submit?')) {
    
            return;
        }
        var formData = new FormData();
        formData.append('course_id', selectedCourse);
        formData.append('academic_year', selectedYear);
       
        formData.append('csv_file', file);

     
        $.ajax({
            url: '/examination/upload_grades_prof/',
            type: 'POST',
            data: formData,
            processData: false,
            contentType: false,
            success: function(response) {
                if (response.redirect_url) {
                    alert(response.message);
                    window.location.href = response.redirect_url;
                }
            },
            error: function(xhr, status, error) {
                if (xhr.responseJSON && xhr.responseJSON.redirect_url) {
                    window.location.href = xhr.responseJSON.redirect_url;
                } else {
                    var errorMessage = xhr.responseJSON ? xhr.responseJSON.error : 'An unexpected error occurred.';
                    alert(errorMessage);
                }
            }
        });
        
    }
    function dwn_temp() {
        let selectedCourse = $('#course-dropdown .menu .item.active').attr('data-value');
        let selectedYear = $('#year-dropdown .menu .item.active').attr('data-value');
    
        if (!selectedCourse || !selectedYear) {
            alert("Please select both course and year.");
            return;
        }

        $.ajax({
            url: `/examination/download_template/`,
            type: 'GET',
            data: { 
                course: selectedCourse, 
                year: selectedYear 
            },
            xhrFields: {
                responseType: 'blob' 
            },
            success: function (data, status, xhr) {
                const disposition = xhr.getResponseHeader('Content-Disposition');
                const matches = /filename="([^"]+)"/.exec(disposition);
                const filename = (matches != null && matches[1]) ? matches[1] : 'template.csv';
        
                const link = document.createElement('a');
                const url = window.URL.createObjectURL(data);
                link.href = url;
                link.download = filename;
                document.body.appendChild(link);
                link.click();
        
                window.URL.revokeObjectURL(url);
                document.body.removeChild(link);
            },
            error: function (xhr, status, error) {
              
                try {                
                    const errorResponse = xhr.responseJSON || { error: 'Unknown error occurred' };
                    alert(`Error: ${errorResponse.error}`);
                } catch (e) {
                    alert('An error occurred while downloading the file.');
                }
            }
        });
        
    }
    
</script>

{% endblock %}