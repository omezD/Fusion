{% extends 'examination/base.html' %}

{% block sidetabmenu %}
<div class="ui medium fluid vertical pointing menu" style="max-width: 320px;">
  <a class="active item" href="{% url 'examination:submitGrades' %}"><B>Submit</B>
    <i class="right floated chevron right icon"></i>
  </a>
  <a class="item" href="{% url 'examination:updateGrades' %}">Verify
    <i class="right floated chevron right icon"></i>
  </a>
  <a class="item" href="{% url 'examination:announcement' %}">Announcement
    <i class="right floated chevron right icon"></i>
  </a>
  <a class="item" href="{% url 'examination:generate_transcript_form' %}">Generate Transcript
    <i class="right floated chevron right icon"></i>
  </a>
</div>
{% endblock %}

{% block content %}
<h1>Submit Results</h1>
<br />

<div style="display: flex; flex-direction: column; gap: 30px;">
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 50px; align-items: center;">
        <div style="display: flex; flex-direction: column; gap: 10px; min-width: 500px;">
            <label for="course-select" style="font-weight: bold;">Course</label>
            <div class="ui fluid search selection dropdown" id="course-dropdown">
                <input type="hidden" name="course" id="course-select">
                <i class="dropdown icon"></i>
                <div class="default text">Select Course</div>
                <div class="menu" id="course-menu">
                    <!-- Courses will be dynamically populated here -->
                </div>
            </div>
        </div>
        <div style="display: flex; flex-direction: column; gap: 10px; min-width: 200px;">
            <label for="year-select" style="font-weight: bold;">Academic Year</label>
            <select id="year-select" name="year" onchange="fetchCoursesByYear(this.value)" class="ui dropdown">
                <option value="" selected>Select Year</option>
                {% for working_year in working_years %}
                <option value="{{ working_year.working_year }}">{{ working_year.working_year }}</option>
                {% empty %}
                <option value="">No Years Available</option>
                {% endfor %}
            </select>
        </div>
    </div>

    <div style="margin-left: 10px; display: flex; gap: 20px;">
        <input type="file" id="csv-file" accept=".csv" style="margin-right: 20px;">
        <button class="ui primary button" style="cursor: pointer; padding: 10px 20px;" onclick="upload()">Upload Results</button>
    </div>

    <div style="margin-left: 10px; display: flex; gap: 20px;">
        <button class="ui primary button" style="cursor: pointer; padding: 10px 20px;" onclick="dwn_temp()">Download Template</button>
    </div>
</div>

<script>
    // Global variable to store all courses
    let allCourses = [];

    // Initialize Semantic UI dropdown
    $(document).ready(function() {
        $('.ui.dropdown').dropdown();
        
        // Initialize search dropdown with custom behavior
        $('#course-dropdown').dropdown({
            fullTextSearch: true,
            onChange: function(value, text, $selectedItem) {
                if ($selectedItem) {
                    // Find the full course details
                    const selectedCourse = allCourses.find(course => course.id == value);
                    if (selectedCourse) {
                        // Set the text to show course code and name
                        $('#course-dropdown .text').text(`${selectedCourse.code} - ${selectedCourse.name}`);
                    }
                }
            }
        });
    });

    // Function to fetch courses based on the selected year
    function fetchCoursesByYear(selectedYear) {
        if (!selectedYear) {
            return;
        }

        $.ajax({
            url: '/examination/submitGrades/',
            type: 'GET',
            data: { academic_year: selectedYear },
            success: function(response) {
                let courseMenu = document.getElementById('course-menu');
                courseMenu.innerHTML = ''; // Clear the current courses
                
                // Store all courses globally
                allCourses = response.courses || [];
                
                // Check if there are any courses in the response
                if (allCourses.length > 0) {
                    allCourses.forEach(function(course) {
                        let courseItem = document.createElement('div');
                        courseItem.className = 'item';
                        courseItem.setAttribute('data-value', course.id);
                        courseItem.innerHTML = `
                            <div class="content">
                                <div class="title">${course.code} - ${course.name}</div>
                            </div>
                        `;
                        courseMenu.appendChild(courseItem);
                    });

                    // Reinitialize dropdown after populating
                    $('#course-dropdown').dropdown('refresh');
                } else {
                    // If no courses are available, show a placeholder
                    let noCoursesItem = document.createElement('div');
                    noCoursesItem.className = 'item disabled';
                    noCoursesItem.textContent = 'No Courses Available';
                    courseMenu.appendChild(noCoursesItem);
                }
            },
            error: function(xhr, status, error) {
                alert('Failed to fetch courses. Please try again.');
            }
        });
    }

    function upload() {
        let selectedCourse = $('#course-select').val();
        let selectedYear = document.getElementById('year-select').value;
        
        let fileInput = document.getElementById('csv-file');
        let file = fileInput.files[0];
        
        if (!selectedCourse || !selectedYear || !file) {
            alert('Please select course, year, and upload a CSV file.');
            return;
        }
        if (!confirm('Are you sure you want to submit? This cannot be undone')) {
            return;
        }

        var formData = new FormData();
        formData.append('course_id', selectedCourse);
        formData.append('academic_year', selectedYear);
        formData.append('csv_file', file);

        $.ajax({
            url: '/examination/upload_grades/',
            type: 'POST',
            data: formData,
            processData: false,
            contentType: false,
            success: function(response) {
                if (response.redirect_url) {
                    alert(response.message);
                    window.location.href = response.redirect_url;
                }
            },
            error: function(xhr, status, error) {
                if (xhr.responseJSON && xhr.responseJSON.redirect_url) {
                    window.location.href = xhr.responseJSON.redirect_url;
                } else {
                    var errorMessage = xhr.responseJSON ? xhr.responseJSON.error : 'An unexpected error occurred.';
                    alert(errorMessage);
                }
            }
        });
    }

    function dwn_temp() {
        let selectedCourse = $('#course-select').val();
        let selectedYear = document.getElementById('year-select').value;
    
        if (!selectedCourse || !selectedYear) {
            alert("Please select both course and year.");
            return;
        }
    
        // Find the selected course details to show in the filename
        const selectedCourseObj = allCourses.find(course => course.id == selectedCourse);
        const courseCode = selectedCourseObj ? selectedCourseObj.code : 'course';
    
        $.ajax({
            url: `/examination/download_template/`,
            type: 'GET',
            data: { 
                course: selectedCourse, 
                year: selectedYear 
            },
            xhrFields: {
                responseType: 'blob'
            },
            success: function (data, status, xhr) {
                // Use course code in the filename if available
                const defaultFilename = `${courseCode}_template_${selectedYear}.csv`;
                const disposition = xhr.getResponseHeader('Content-Disposition');
                const matches = /filename="([^"]+)"/.exec(disposition);
                const filename = (matches != null && matches[1]) ? matches[1] : defaultFilename;
        
                const link = document.createElement('a');
                const url = window.URL.createObjectURL(data);
                link.href = url;
                link.download = filename;
                document.body.appendChild(link);
                link.click();
        
                window.URL.revokeObjectURL(url);
                document.body.removeChild(link);
            },
            error: function (xhr, status, error) {
                try {
                    const errorResponse = xhr.responseJSON || { error: 'Unknown error occurred' };
                    alert(`Error: ${errorResponse.error}`);
                } catch (e) {
                    alert('An error occurred while downloading the file.');
                }
            }
        });
    }
</script>

{% endblock %}