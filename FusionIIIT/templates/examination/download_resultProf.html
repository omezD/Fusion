{% extends 'examination/base.html' %}

{% block sidetabmenu %}
<div class="ui medium fluid vertical pointing menu" style="max-width: 320px;">
  <a class="item" href="{% url 'examination:submitGradesProf' %}">Submit
    <i class="right floated chevron right icon"></i>
  </a>
  <a class="active item" href="{% url 'examination:downloadGrades' %}"><B>Download Grades</B>
    <i class="right floated chevron right icon"></i>
  </a>
  {% comment %} <a class="item" href="{% url 'examination:updateGrades' %}">Verify
    <i class="right floated chevron right icon"></i>
  </a>
  <a class="item" href="{% url 'examination:authenticate' %}">Authenticate Course
    <i class="right floated chevron right icon"></i>
  </a>
  <a class="item" href="{% url 'examination:announcement' %}">Announcement
    <i class="right floated chevron right icon"></i>
  </a>
  <a class="item" href="{% url 'examination:generate_transcript_form' %}">Generate Transcript
    <i class="right floated chevron right icon"></i>
  </a> {% endcomment %}
</div>
{% endblock %}
{% block content %}
<h1>Download Result</h1>
<br />

<div style="display: flex; flex-direction: column; gap: 30px;">
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 50px; align-items: center;">
        <div style="display: flex; flex-direction: column; gap: 10px; min-width: 500px;">
            <label for="course-select" style="font-weight: bold;">Course</label>
            <div style="position: relative; display: inline-block; width: 100%; cursor: pointer;">
                <select id="course-select" name="course" style="padding: 12px; font-size: 1rem; min-height: 50px; width: 100%; background: white; outline: none; transition: all 0.3s ease-in-out; cursor: pointer;">
                    <option value="">Select Course</option>
                    <option value="">No Courses Available</option> <!-- Populated dynamically -->
                </select>
            </div>
        </div>
        <div style="display: flex; flex-direction: column; gap: 10px; min-width: 300px;">
            <label for="year-select" style="font-weight: bold;">Academic Year</label>
            <select id="year-select" name="year" onchange="fetchCoursesByYear(this.value)" style="padding: 12px; font-size: 1rem; min-height: 50px; width: 100%; background: white;  appearance: none; outline:none; cursor: pointer;">
                <option value="" selected>Select Year</option>
                {% for working_year in working_years %}
                <option value="{{ working_year.working_year }}">{{ working_year.working_year }}</option>
                {% empty %}
                <option value="">No Years Available</option>
                {% endfor %}
            </select>
        </div>
    </div>

    

    <div style="margin-left: 10px; display: flex; gap: 20px;">
        <button class="ui primary button" style="cursor: pointer; padding: 10px 20px;" onclick="dwn_grade()">Download Grades</button>
    </div>
</div>

<script>
    // Function to fetch courses based on the selected year
    function fetchCoursesByYear(selectedYear) {
        if (!selectedYear) {
            return;
        }

        $.ajax({
            url: '/examination/downloadGrades/',  // Replace with your API endpoint
            type: 'GET',
            data: { academic_year: selectedYear },  // Send the selected year as a parameter
            success: function(response) {
                let courseSelect = document.getElementById('course-select');
                courseSelect.innerHTML = ''; // Clear the current courses dropdown
                
                // Check if there are any courses in the response
                if (response.courses && response.courses.length > 0) {
                    response.courses.forEach(function(course) {
                        let option = document.createElement('option');
                        option.value = course.id;
                        option.text = `${course.code} - ${course.name}`;
                        courseSelect.appendChild(option);
                    });
                } else {
                    // If no courses are available, show a placeholder
                    let noCoursesOption = document.createElement('option');
                    noCoursesOption.text = 'No Courses Available';
                    courseSelect.appendChild(noCoursesOption);
                }
            },
            error: function(xhr, status, error) {
                alert('Failed to fetch courses. Please try again.');
            }
        });
    }

    
    function dwn_grade() {
        let selectedCourse = document.getElementById('course-select').value;
        let selectedYear = document.getElementById('year-select').value;
        if (!selectedCourse || !selectedYear) {
            alert('Please select course and year.');
            return;
        }
        var formData = new FormData();
        formData.append('course_id', selectedCourse);
        formData.append('academic_year', selectedYear);
        
        $.ajax({
            url: '/examination/generate_pdf/',
            type: 'POST',
            data: formData,
            processData: false,
            contentType: false,
            xhrFields: {
                responseType: 'blob' // Expect binary data (PDF)
            },
            success: function(response) {
                // Create a Blob object from the response
                var blob = new Blob([response], { type: 'application/pdf' });
        
                // Create a temporary link element
                var link = document.createElement('a');
                link.href = window.URL.createObjectURL(blob);
                link.download = 'grades.pdf'; // Set the file name
        
                // Append the link, trigger the click, and remove it
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            },
            error: function(xhr, status, error) {
                console.error('Error:', error);
                alert('An error occurred.');
            }
        });
    }        
</script>

{% endblock %}